# Copyright 2019, Oath Inc.
# Licensed under the terms of the Apache License, Version 2.0. See LICENSE file for terms.
from ariel import utils, LOGGER

import boto3
import datetime
import os
import pandas as pd
import sys
import time

def load(config):

    # If local files exists and is less than a day old, just use it.
    cache_file = '/tmp/cached-reserved-instances.csv'
    caching = utils.get_config_value(config, 'DEFAULTS', 'CACHING', False)
    mtime = 0
    if caching:
        try:
            mtime = os.stat(cache_file).st_mtime
        except FileNotFoundError:
            pass

    if mtime > time.time() - 86400:
        LOGGER.info("Using existing cache file: " + cache_file)
        ris = pd.read_csv(cache_file)
    else:
        account, role = utils.get_master(config)
        region   = utils.get_config_value(config, 'RESERVED_INSTANCES', 'AWS_REGION',
                   utils.get_config_value(config, 'DEFAULTS', 'AWS_REGION',
                                          os.environ.get('AWS_DEFAULT_REGION')))
        # start date cannot be after 2 days ago for GetReservationUtilization
        monthend = datetime.date.today()
        monthstart = (datetime.date.today() - datetime.timedelta(days=31))

        skip_accounts = utils.get_config_value(config, 'RI_PURCHASES', 'SKIP_ACCOUNTS', '').split(' ')
        expiration_days = int(utils.get_config_value(config, 'RI_PURCHASES', 'EXPIRATION_DAYS', '0'))

        ris = []
        if role != '':
            session = utils.assume_role(boto3.Session(), role)
            ce = session.client('ce', region_name=region)

            rsp = ce.get_reservation_utilization(
                TimePeriod={ "Start": str(monthstart), "End": str(monthend) },
                GroupBy=[{ "Type": "DIMENSION", "Key": "SUBSCRIPTION_ID" }]
            )

            while True:
                groups = rsp['UtilizationsByTime'][0]['Groups']
                for row in groups:
                    # Skip our skip accounts.
                    if row['Attributes']['accountId'] in skip_accounts:
                        continue

                    # Make sure to only capture active RIs
                    endDate = datetime.datetime.strptime(row['Attributes']['endDateTime'], "%Y-%m-%dT%H:%M:%S.000Z")
                    if endDate.date() > datetime.date.today() + datetime.timedelta(days=expiration_days):

                        # these mappings are needed for CUR compatibility
                        # the current pricing report uses the following operating systems:
                        # Linux, RHEL, SUSE, Windows  
                        platform = row['Attributes']['platform']
                        if platform == 'Linux/UNIX':
                            operatingSystem = 'Linux'
                        elif platform == 'Red Hat Enterprise Linux':
                            operatingSystem = 'RHEL'
                        elif platform.startswith("Windows "):
                            # Windows with * missing from pricing data.
                            continue
                        else:
                            operatingSystem = platform

                        ri = {
                            'accountid': int(row['Attributes']['accountId']),
                            'accountname': row['Attributes']['accountName'],
                            'reservationid': row['Attributes']['leaseId'],
                            'subscriptionid': row['Attributes']['subscriptionId'],
                            'startdate': row['Attributes']['startDateTime'],
                            'enddate': row['Attributes']['endDateTime'],
                            'state': row['Attributes']['subscriptionStatus'],
                            'quantity': int(row['Attributes']['numberOfInstances']),
                            'availabilityzone': row['Attributes']['availabilityZone'],
                            'region': row['Attributes']['region'],
                            'instancetype': row['Attributes']['instanceType'],
                            'paymentoption': row['Attributes']['subscriptionType'],
                            'tenancy': row['Attributes']['tenancy'],
                            'operatingsystem': operatingSystem,
                            'amortizedhours': int(row['Utilization']['PurchasedHours']),
                            'amortizedupfrontprice': float(row['Utilization']['AmortizedUpfrontFee']),
                            'amortizedrecurringfee': float(row['Utilization']['AmortizedRecurringFee']),
                            'offeringclass': row['Attributes']['offeringType'],
                            'scope': row['Attributes']['scope'],
                        }
                        ris.append(ri)

                if 'NextToken' in rsp:
                    rsp = ce.get_reservation_utilization(NextToken=rsp['NextToken'])
                    continue
                break

        ris = pd.DataFrame.from_records(ris)
        if (len(ris) == 0):
            ris = pd.DataFrame(columns=['accountid','accountname','reservationid','subscriptionid','startdate',
               'enddate','state','quantity','availabilityzone','region','instancetype',
               'paymentoption','tenancy','operatingsystem','amortizedhours',
               'amortizedupfrontprice','amortizedrecurringfee','offeringclass','scope'])
        else:
            ris = pd.DataFrame.from_records(ris)

        ris.to_csv(cache_file, index=False)

    LOGGER.info("Loaded {} reserved instances".format(len(ris)))
    return ris


def cli():
    import argparse, csv
    parser = argparse.ArgumentParser(prog='{} {}'.format(*(sys.argv[0], sys.argv[1])))
    parser.add_argument('--config', required=True, help='Config file to load for Ariel configuration')

    args = parser.parse_args(args=sys.argv[2:])
    ris = load(utils.load_config(args.config))
    ris.to_csv(sys.stdout)

if __name__ == '__main__':
    cli()
